{% load static %}

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>SyntaxSprint - Carrera de código</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="{% static 'assets/favicon.ico' %}"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@100;200;300;400;500;600;700;800;900&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="{% static 'styles.css' %}" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      #gist-content {
        text-align: center;
        margin-top: 20px;
      }

      #gist-content pre {
        display: inline-block;
        text-align: left;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f8f8f8;
        white-space: pre-wrap;
      }

      .editable {
        width: 100%;
        height: auto;
        border: none;
        padding: 0;
        margin: 0;
        background: transparent;
        color: inherit;
        font-size: inherit;
        font-family: inherit;
        resize: none;
        outline: none;
        white-space: pre-wrap;
        overflow-wrap: break-word;
      }

      .stats {
        margin-top: 20px;
      }
    </style>
  </head>
  <body class="d-flex flex-column h-100">
    <main class="flex-shrink-0">
      <nav class="navbar navbar-expand-lg navbar-light bg-white py-3">
        <div class="container px-5">
          <a class="navbar-brand" href="{% url 'index' %}"
            ><span class="fw-bolder text-primary">SyntaxSprint</span></a
          >
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0 small fw-bolder">
              <li class="nav-item">
                <a class="nav-link" href="{% url 'index' %}">Inicio</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'settings' %}">Ajustes</a>
              </li>
              {% if user.is_authenticated %}
              <li class="nav-item">
                <span class="nav-link">Hola, {{ user.username }}</span>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'logout' %}">Cerrar sesión</a>
              </li>
              {% else %}
              <li class="nav-item">
                <a class="nav-link" href="{% url 'login' %}">Iniciar sesión</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'signup' %}">Registrarse</a>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
      </nav>

      <header class="py-5">
        <div class="container-fluid px-5 pb-5">
          <div class="row gx-5 align-items-center h-100">
            <div class="col-xxl-5 mx-auto">
              <div>
                <h1 class="display-2 fw-bolder mb-8">
                  <span
                    class="text-gradient row d-flex justify-content-center align-items-center h-100"
                    >¿Qué tan rápido eres escribiendo código?</span
                  >
                </h1>

                <div class="container mt-5">
                  <div
                    class="d-grid gap-3 d-sm-flex justify-content-sm-center mb-3"
                  >
                    <button
                      id="start-test"
                      class="btn btn-outline-dark btn-lg px-5 py-3 fs-6 fw-bolder"
                    >
                      Iniciar Test
                    </button>
                  </div>
                  <div id="gist-content" class="mt-5"></div>
                  <div class="stats">
                    <p id="wpm"></p>
                    <p id="accuracy"></p>
                    <p id="errors"></p>
                  </div>
                </div>

                <script>
                  $(document).ready(function () {
                    let startTime;
                    let testText = "";

                    $("#start-test").click(function () {
                      console.log("Botón 'Iniciar Test' clickeado");
                      $.ajax({
                        url: "{% url 'get_python_function' %}",
                        method: "GET",
                        success: function (data) {
                          console.log("Respuesta recibida:", data);
                          if (data.error) {
                            $("#gist-content").html(
                              '<div class="alert alert-danger" role="alert">' +
                                data.error +
                                "</div>"
                            );
                          } else {
                            $("#gist-content").html(
                              "<pre id='test-text' contenteditable='true' class='editable'>" +
                                data.code +
                                "</pre>"
                            );
                            testText = data.code;
                            startTime = new Date().getTime();
                          }
                        },
                        error: function (xhr, status, error) {
                          console.log("Error en la solicitud AJAX:", error);
                          $("#gist-content").html(
                            '<div class="alert alert-danger" role="alert">Error al obtener el Gist: ' +
                              error +
                              "</div>"
                          );
                        },
                      });
                    });

                    $(document).on("blur", "#test-text", function () {
                      const inputText = $(this).text();
                      const elapsedTime =
                        (new Date().getTime() - startTime) / 60000; // minutos
                      const wordsTyped = inputText.split(/\s+/).length;
                      const wpm = Math.round(wordsTyped / elapsedTime);

                      const correctChars = testText.slice(0, inputText.length);
                      const errors = inputText
                        .split("")
                        .reduce((acc, char, idx) => {
                          return acc + (char !== correctChars[idx] ? 1 : 0);
                        }, 0);
                      const accuracy = Math.round(
                        ((inputText.length - errors) / inputText.length) * 100
                      );

                      $("#wpm").text(`WPM: ${wpm}`);
                      $("#accuracy").text(`Precisión: ${accuracy}%`);
                      $("#errors").text(`Errores: ${errors}`);
                    });
                  });
                </script>
              </div>
            </div>
          </div>
        </div>
      </header>

      <section class="bg-light py-5">
        <div class="container px-5">
          <div class="row gx-5 justify-content-center">
            <div class="col-xxl-8">
              <div class="text-center my-5">
                <h2 class="display-5 fw-bolder">
                  <span class="text-gradient d-inline"
                    >Sobre este proyecto</span
                  >
                </h2>
                <p class="lead fw-light mb-4">
                  Proyecto inspirado en la página web monkeytype.com
                </p>

                <div class="d-flex justify-content-center fs-2 gap-4">
                  <a class="text-gradient" href="#!"
                    ><i class="bi bi-linkedin"></i
                  ></a>
                  <a class="text-gradient" href="#!"
                    ><i class="bi bi-github"></i
                  ></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="bg-white py-4 mt-auto">
      <div class="container px-5">
        <div
          class="row align-items-center justify-content-between flex-column flex-sm-row"
        >
          <div class="col-auto">
            <div class="small m-0">
              Copyright &copy; Crédito a los respectivos autores
            </div>
          </div>
          <div class="col-auto">
            <a class="small" href="#!">LinkedIn</a>
            <span class="mx-1">&middot;</span>
            <a class="small" href="#!">GitHub</a>
            <span class="mx-1">&middot;</span>
            <a class="small" href="#!">Portfolio</a>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/scripts.js' %}"></script>
  </body>
</html>
